document.addEventListener("DOMContentLoaded",init,false);function init(){$("#footer").hide(0);var game={};game.canvasTag=document.getElementById("game");game.canvas=game.canvasTag.getContext("2d");game.canvas.width=512;game.canvas.height=384;game.coordinatesTag=document.getElementById("coordinates");game.canvasTag.innerHTML="";game.mouse={x:0,y:0};game.canvasTag.onmousemove=function(e){updateMousePosition(game,e)};game.keyboard={status:{},onKeydown:function(event){event.preventDefault();this.status[event.keyCode]=true},onKeyup:function(event){delete this.status[event.keyCode]},};window.addEventListener("keydown",function(event){game.keyboard.onKeydown(event)},false);window.addEventListener("keyup",function(event){game.keyboard.onKeyup(event)},false);window.addEventListener("keydown",function(event){event.preventDefault()},false);game.quest={tutorialActivated:true,bookNumber:0,finished:false,};game.FPS=60;setInterval(function(){run(game)},1000/game.FPS);game.currentLevel=new Level();game.currentLevel.loadLevel(data_levels[startLevel]);game.hero=new Hero(startX,startY);game.hero.setCurrentLevel(game.currentLevel.id,game.currentLevel.tiles)}function updateMousePosition(game,e){game.mouse.x=e.clientX-game.canvasTag.offsetLeft;game.mouse.y=e.clientY-game.canvasTag.offsetTop}function run(game){var startTime=(new Date()).getMilliseconds();if(game.quest.bookNumber>=7){if(!game.quest.finished){var t=setTimeout(function(){end(game,t)},3000);game.quest.finished=true}return}if(game.hero.state=="death"){game.currentLevel.loadLevel(data_levels[game.hero.checkpoint.level]);game.hero.absPosition.x=game.hero.checkpoint.position.x;game.hero.absPosition.y=game.hero.checkpoint.position.y;game.hero.setCurrentLevel(game.currentLevel.id,game.currentLevel.tiles);game.hero.state="normal"}game.hero.move(game.keyboard.status);game.quest=game.hero.checkCollideWithSpecialItem(game.quest);if(game.hero.collideWithWarp()){game.currentLevel.loadLevel(data_levels[data_levels[game.currentLevel.id].warp[game.hero.warp.current]]);game.hero.setPositionFromWarp();game.hero.setCurrentLevel(game.currentLevel.id,game.currentLevel.tiles)}game.canvas.clearRect(0,0,game.canvas.width,game.canvas.height);game.currentLevel.resetLight();if(game.hero.powers.hasLight){game.currentLevel.applyLight(game.hero.gridPosition.x*tileSize,game.hero.gridPosition.y*tileSize,game.hero.getLightFactor(),game.hero.powers.hasView)}for(var i=0;i<game.currentLevel.additionnalLights.length;++i){game.currentLevel.applyLight(game.currentLevel.additionnalLights[i][0]*tileSize,game.currentLevel.additionnalLights[i][1]*tileSize,8,false)}game.hero.draw(game.canvas);game.currentLevel.draw(game.canvas);game.hero.drawSpecialEffects(game.canvas);if(game.hero.isReadingText.state==true){displayText(game.hero.isReadingText.content,game.hero.isReadingText.position)}game.quest=applyGlobalEvents(game.quest,game.currentLevel.id);game.hero.isReadingText.state=false}function applyGlobalEvents(quest,levelNumber){if(quest.tutorialActivated&&levelNumber==0){displayText("Arrow keys or A-D to move in the darkness","bottom")}if(quest.tutorialActivated&&levelNumber==5){displayText("Arrow keys or A-D-W-S to swim. Don't forget to breath...","bottom")}if(quest.tutorialActivated&&levelNumber==16){displayText("Avoid the red pikes !","top")}if(levelNumber==2){displayTitle("I Was Here")}if(quest.tutorialActivated&&levelNumber==22){quest.tutorialActivated=false}return quest}function end(t){clearTimeout(t);$("#footer").fadeIn(3000);$("#gameDiv").hide(5000,function(){$("#gameDiv").html(endingHTML);$("#gameDiv").show(4000)})}function Hero(x,y){this.scale=1;this.size=5;this.direction=1;this.gridPosition={x:x,y:y};this.absPosition={x:x*(tileSize+0.5),y:y*(tileSize+0.5)};this.grav=0;this.box={w:12,h:16};this.state="normal";this.hasMoved=false;this.isJumping=false;this.autodiving={state:"up",timer:10};this.oxygen={max:2500,current:1};this.isReadingText={state:false,content:""};this.powers={hasLight:false,canJump:false,hasView:false};this.lightHaloDist=10;this.checkpoint={level:0,position:{x:0,y:0}};this.currentLevelId=0;this.currentLevelTiles=null;this.warp={current:"none",target:{level:0,x:0,y:0}}}Hero.prototype={draw:function(canvas){if(this.direction==1){canvas.drawImage(texHeroL,this.absPosition.x-1.4*this.box.w,this.absPosition.y-this.box.h)}else{canvas.drawImage(texHeroR,this.absPosition.x-1.4*this.box.w,this.absPosition.y-this.box.h)}},drawSpecialEffects:function(canvas){if((this.state=="swim"||!this.powers.hasLight)&&this.state!="death"){if(this.direction==1){canvas.drawImage(texHeroEyes,this.absPosition.x+15-2.4*this.box.w,this.absPosition.y+6-this.box.h)}else{canvas.drawImage(texHeroEyes,this.absPosition.x+16-1.4*this.box.w,this.absPosition.y+6-this.box.h)}}},drawBoundingBox:function(canvas){canvas.fillStyle="#0f0";canvas.fillRect(this.absPosition.x-this.box.w,this.absPosition.y-this.box.h/2,this.box.w*2,this.box.h*1.5)},setCurrentLevel:function(levelId,levelTiles){this.currentLevelId=levelId;this.currentLevelTiles=levelTiles},setPositionFromWarp:function(warp){this.absPosition.x=this.warp.target.x;this.absPosition.y=this.warp.target.y;this.warp.current="none"},saveCheckpoint:function(){this.checkpoint.level=this.currentLevelId;this.checkpoint.position.x=this.absPosition.x;this.checkpoint.position.y=this.absPosition.y},move:function(keyboard){if(this.state=="normal"){this.moveNormal(keyboard);if(this.collideWithWater()){this.state="swim";this.oxygen.current=this.oxygen.max}}else{if(this.state=="swim"){if(--this.oxygen.current<=0){this.state="death"}this.moveSwim(keyboard);if(this.getOutOfWater()){this.state="normal";this.grav=maxJump*2/3}}else{}}},moveNormal:function(keyboard){if((keyboard[KEY_LEFT]||keyboard[KEY_LEFT2])&&!this.collideWithLeftWall()&&!this.collideWithLeftFakeWall()){this.absPosition.x-=heroSpeed;this.direction=1}if((keyboard[KEY_RIGHT]|keyboard[KEY_RIGHT2])&&!this.collideWithRightWall()&&!this.collideWithRightFakeWall()){this.absPosition.x+=heroSpeed;this.direction=-1}if(this.powers.canJump&&(keyboard[KEY_UP]|keyboard[KEY_UP2])&&!this.isJumping){this.grav=maxJump;this.isJumping=true}this.applyGravity();this.checkCollideWithCheckpoint();if(this.collideWithSpike()){this.state="death"}this.gridPosition={x:Math.floor(this.absPosition.x/tileSize),y:Math.floor(this.absPosition.y/tileSize)}},moveSwim:function(keyboard){if((keyboard[KEY_LEFT]|keyboard[KEY_LEFT2])&&!this.collideWithLeftWall()){this.absPosition.x-=heroSpeed;this.direction=1}if((keyboard[KEY_RIGHT]||keyboard[KEY_RIGHT2])&&!this.collideWithRightWall()){this.absPosition.x+=heroSpeed;this.direction=-1}if((keyboard[KEY_UP]|keyboard[KEY_UP2])&&!this.collideWithCeiling()){this.absPosition.y-=heroSpeed}if((keyboard[KEY_DOWN]||keyboard[KEY_DOWN2])&&!this.collideWithFloor()){this.absPosition.y+=heroSpeed}if(this.autodiving.state=="up"&&!this.collideWithCeiling()){this.absPosition.y-=0.2;if(--this.autodiving.timer==0){this.autodiving.state="down";this.autodiving.timer=20}}else{if(this.autodiving.state=="down"&&!this.collideWithFloor()){this.absPosition.y+=0.2;if(--this.autodiving.timer==0){this.autodiving.state="up";this.autodiving.timer=20}}}if(this.collideWithSpike()){this.state="death"}this.gridPosition={x:Math.floor(this.absPosition.x/tileSize),y:Math.floor(this.absPosition.y/tileSize)}},applyGravity:function(){this.absPosition.y+=this.grav/2;if(this.grav<16){this.grav+=gravity}while(this.collideWithFloor()){this.absPosition.y-=gravity/2;this.grav=0;if(this.isJumping){this.isJumping=false}}if(this.collideWithCeiling()){this.grav=3}},collideWithFloor:function(){if(this.absPosition.y+this.box.h>=screenSize.h||this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w+4)/tileSize)+Math.floor((this.absPosition.y+this.box.h)/tileSize)*16].type>0||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w-4)/tileSize)+Math.floor((this.absPosition.y+this.box.h)/tileSize)*16].type>0){return true}return false},collideWithCeiling:function(){if(this.absPosition.y-this.box.h<=0||this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w+4)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2)/tileSize)*16].type>0||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w-4)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2)/tileSize)*16].type>0){return true}return false},collideWithLeftWall:function(){if(this.absPosition.x-this.box.w<=0||this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2+4)/tileSize)*16].type>0||this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w)/tileSize)+Math.floor((this.absPosition.y+this.box.h-4)/tileSize)*16].type>0){return true}return false},collideWithRightWall:function(){if(this.absPosition.x-this.box.w<=0||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2+4)/tileSize)*16].type>0||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w)/tileSize)+Math.floor((this.absPosition.y+this.box.h-4)/tileSize)*16].type>0){return true}return false},collideWithWater:function(){if(this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w+4)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2)/tileSize)*16].type==-1||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w-4)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2)/tileSize)*16].type==-1){return true}return false},collideWithLeftFakeWall:function(){if(this.powers.hasView){return false}if(this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2+4)/tileSize)*16].type==F||this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w)/tileSize)+Math.floor((this.absPosition.y+this.box.h-4)/tileSize)*16].type==F){return true}else{return false}},collideWithRightFakeWall:function(){if(this.powers.hasView){return false}if(this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w)/tileSize)+Math.floor((this.absPosition.y-this.box.h/2+4)/tileSize)*16].type==F||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w)/tileSize)+Math.floor((this.absPosition.y+this.box.h-4)/tileSize)*16].type==F){return true}else{return false}},collideWithSpike:function(){var point1=Math.floor((this.absPosition.x-5)/tileSize)+Math.floor((this.absPosition.y)/tileSize)*16;var point2=Math.floor((this.absPosition.x+5)/tileSize)+Math.floor((this.absPosition.y)/tileSize)*16;var point3=Math.floor((this.absPosition.x)/tileSize)+Math.floor((this.absPosition.y+15)/tileSize)*16;var point4=Math.floor((this.absPosition.x)/tileSize)+Math.floor((this.absPosition.y-10)/tileSize)*16;if((this.currentLevelTiles[point1].type==P||this.currentLevelTiles[point1].type==U)&&(this.currentLevelTiles[point2].type==P||this.currentLevelTiles[point2].type==U)&&(this.currentLevelTiles[point3].type==P||this.currentLevelTiles[point3].type==U)&&(this.currentLevelTiles[point4].type==P||this.currentLevelTiles[point4].type==U)){return true}return false},getOutOfWater:function(){if(this.currentLevelTiles[Math.floor((this.absPosition.x-this.box.w+4)/tileSize)+Math.floor((this.absPosition.y+this.box.h/2)/tileSize)*16].type==0||this.currentLevelTiles[Math.floor((this.absPosition.x+this.box.w-4)/tileSize)+Math.floor((this.absPosition.y+this.box.h/2)/tileSize)*16].type==0){return true}return false},collideWithWarp:function(){if(this.absPosition.x<=this.box.w){this.warp.current="left";this.warp.target.x=screenSize.w-this.box.w-1;this.warp.target.y=this.absPosition.y;return true}if(this.absPosition.x>=screenSize.w-this.box.w){this.warp.current="right";this.warp.target.x=this.box.w+1;this.warp.target.y=this.absPosition.y;return true}if(this.absPosition.y>=screenSize.h-2*this.box.h){this.warp.current="down";this.warp.target.x=this.absPosition.x;this.warp.target.y=this.box.h+4;return true}if(this.absPosition.y<=this.box.h){this.warp.current="top";this.warp.target.x=this.absPosition.x;this.warp.target.y=screenSize.h-2*this.box.h-4;this.grav=maxJump;return true}return false},checkCollideWithCheckpoint:function(){if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==S){this.saveCheckpoint();this.isReadingText={state:true,position:"top",content:"Game saved"}}},checkCollideWithSpecialItem:function(quest){if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==POWERUP_LIGHT){if(!this.powers.hasLight){this.powers.hasLight=true;this.saveCheckpoint()}this.isReadingText={state:true,position:"bottom",content:"You collected the LIGHT! Find your way in the darkness."}}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==POWERUP_JUMP){if(!this.powers.canJump){this.powers.canJump=true;this.saveCheckpoint()}this.isReadingText={state:true,position:"bottom",content:"You collected the BOOTS! Jump with UP - W"}}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==POWERUP_VIEW){if(!this.powers.hasView){this.powers.hasView=true;this.saveCheckpoint()}this.isReadingText={state:true,position:"bottom",content:"You found the SUPER VIEW! You can cross secret walls..."}}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B1){if(!data_quest[0].picked){data_quest[0].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="bottom";this.isReadingText.content=data_quest[0].content}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B2){if(!data_quest[1].picked){data_quest[1].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="bottom";this.isReadingText.content=data_quest[1].content}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B3){if(!data_quest[2].picked){data_quest[2].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="bottom";this.isReadingText.content=data_quest[2].content}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B4){if(!data_quest[3].picked){data_quest[3].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="bottom";this.isReadingText.content=data_quest[3].content}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B5){if(!data_quest[4].picked){data_quest[4].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="top";this.isReadingText.content=data_quest[4].content}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B6){if(!data_quest[5].picked){data_quest[5].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="bottom";this.isReadingText.content=data_quest[5].content}if(this.currentLevelTiles[this.gridPosition.x+this.gridPosition.y*16].type==B7){if(!data_quest[6].picked){data_quest[6].picked=true;++quest.bookNumber}this.isReadingText.state=true;this.isReadingText.position="bottom";this.isReadingText.content=data_quest[6].content}return quest},getLightFactor:function(){if(this.state=="swim"){return(this.lightHaloDist*(this.oxygen.current-this.oxygen.max/8)/(this.oxygen.max-this.oxygen.max/8))}else{if(this.state=="normal"){return(this.lightHaloDist)}else{return 0}}}};function Tile(x,y,type){this.scale=tileSize;this.light=1;this.type=type;this.lighted=false;this.tag=false;this.gridPosition={x:x,y:y};this.absPosition={x:x*tileSize,y:y*tileSize}}Tile.prototype={draw:function(canvas){var shadowNeeded=true;switch(this.type){case 0:break;case W:canvas.fillStyle="rgba(0,0,100,0.5)";canvas.fillRect(this.absPosition.x,this.absPosition.y,this.scale,this.scale);break;case P:canvas.drawImage(texSpike,this.absPosition.x,this.absPosition.y);break;case U:canvas.drawImage(texSpike,this.absPosition.x,this.absPosition.y);canvas.fillStyle="rgba(0,0,100,0.5)";canvas.fillRect(this.absPosition.x,this.absPosition.y,this.scale,this.scale);break;case S:canvas.drawImage(texSave,this.absPosition.x,this.absPosition.y);break;case F:if(this.tag){canvas.fillStyle="rgb(28,28,28)";canvas.fillRect(this.absPosition.x,this.absPosition.y,this.scale,this.scale)}else{shadowNeeded=false;canvas.fillStyle="rgb(0, 0, 0)";canvas.fillRect(this.absPosition.x,this.absPosition.y,this.scale,this.scale)}break;case POWERUP_LIGHT:canvas.drawImage(texPLight,this.absPosition.x,this.absPosition.y);break;case POWERUP_JUMP:canvas.drawImage(texPBoots,this.absPosition.x,this.absPosition.y);break;case POWERUP_VIEW:canvas.drawImage(texPView,this.absPosition.x,this.absPosition.y);break;case 1:shadowNeeded=false;canvas.fillStyle="rgb(0, 0, 0)";canvas.fillRect(this.absPosition.x,this.absPosition.y,this.scale,this.scale);break;case A:canvas.drawImage(texBDown,this.absPosition.x,this.absPosition.y);break;case V:canvas.drawImage(texBUp,this.absPosition.x,this.absPosition.y);break;case B1:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break;case B2:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break;case B3:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break;case B4:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break;case B5:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break;case B6:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break;case B7:canvas.drawImage(texBook,this.absPosition.x,this.absPosition.y);break}if(shadowNeeded){canvas.fillStyle="rgba(0,0,0, "+this.light+")";canvas.fillRect(this.absPosition.x,this.absPosition.y,this.scale,this.scale)}},resetLight:function(){this.lighted=false},setLight:function(light,superView){this.light=light;this.lighted=true;if(superView){this.tag=true}},};function Level(levelFile){this.name="";this.position={x:0,y:0};this.tiles=new Array();this.additionnalLights=new Array()}Level.prototype={draw:function(canvas){for(var y=0;y<12;++y){for(var x=0;x<16;++x){this.tiles[x+y*16].draw(canvas)}}},loadLevel:function(levelFile){this.tiles=new Array();this.additionnalLights=new Array();this.name=levelFile.name;this.id=levelFile.id;for(var i=0;i<levelFile.lights.length;++i){this.additionnalLights.push(levelFile.lights[i])}this.position=levelFile.position;for(var y=0;y<12;++y){for(var x=0;x<16;++x){this.tiles.push(new Tile(x,y,levelFile.tiles[x+y*16]))}}},resetLight:function(){for(var y=0;y<12;++y){for(var x=0;x<16;++x){this.tiles[x+y*16].resetLight()}}},applyLight:function(targetX,targetY,lightPower,superView){var gridPos={x:Math.floor(targetX/tileSize),y:Math.floor(targetY/tileSize)};var diffCase=0;var lightFactor=0;for(var y=0;y<12;++y){for(var x=0;x<16;++x){diffCase=Math.sqrt(Math.pow(Math.abs(x-gridPos.x),2)+Math.pow(Math.abs(y-gridPos.y),2));if(diffCase>=lightPower){lightFactor=1}else{lightFactor=1/lightPower*diffCase}if(this.tiles[x+y*16].lighted){this.tiles[x+y*16].setLight(Math.min(lightFactor,this.tiles[x+y*16].light),superView)}else{this.tiles[x+y*16].setLight(lightFactor,superView)}}}},};function displayText(text,position){var context=document.getElementById("game").getContext("2d");context.fillStyle="#fff";context.textAlign="center";context.font="bold 36px gamefont";var b=0;if(position=="top"){b=50}else{b=340}context.fillText(text,screenSize.w/2,b)}function displayTitle(text){var context=document.getElementById("game").getContext("2d");context.fillStyle="#fff";context.textAlign="center";context.textBaseline="top";context.font="bold 90px gamefont";context.fillText(text,screenSize.w/2,120)};