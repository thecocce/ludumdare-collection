var buzz={defaults:{autoplay:false,duration:5000,formats:[],loop:false,placeholder:"--",preload:"metadata",volume:80},types:{mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},sounds:[],el:document.createElement("audio"),sound:function(a,o){o=o||{};var h=0,n=[],c={},b=buzz.isSupported();this.load=function(){if(!b){return this}this.sound.load();return this};this.play=function(){if(!b){return this}this.sound.play();return this};this.togglePlay=function(){if(!b){return this}if(this.sound.paused){this.sound.play()}else{this.sound.pause()}return this};this.pause=function(){if(!b){return this}this.sound.pause();return this};this.isPaused=function(){if(!b){return null}return this.sound.paused};this.stop=function(){if(!b){return this}this.setTime(this.getDuration());this.sound.pause();return this};this.isEnded=function(){if(!b){return null}return this.sound.ended};this.loop=function(){if(!b){return this}this.sound.loop="loop";this.bind("ended.buzzloop",function(){this.currentTime=0;this.play()});return this};this.unloop=function(){if(!b){return this}this.sound.removeAttribute("loop");this.unbind("ended.buzzloop");return this};this.mute=function(){if(!b){return this}this.sound.muted=true;return this};this.unmute=function(){if(!b){return this}this.sound.muted=false;return this};this.toggleMute=function(){if(!b){return this}this.sound.muted=!this.sound.muted;return this};this.isMuted=function(){if(!b){return null}return this.sound.muted};this.setVolume=function(i){if(!b){return this}if(i<0){i=0}if(i>100){i=100}this.volume=i;this.sound.volume=i/100;return this};this.getVolume=function(){if(!b){return this}return this.volume};this.increaseVolume=function(i){return this.setVolume(this.volume+(i||1))};this.decreaseVolume=function(i){return this.setVolume(this.volume-(i||1))};this.setTime=function(i){if(!b){return this}this.whenReady(function(){this.sound.currentTime=i});return this};this.getTime=function(){if(!b){return null}var i=Math.round(this.sound.currentTime*100)/100;return isNaN(i)?buzz.defaults.placeholder:i};this.setPercent=function(i){if(!b){return this}return this.setTime(buzz.fromPercent(i,this.sound.duration))};this.getPercent=function(){if(!b){return null}var i=Math.round(buzz.toPercent(this.sound.currentTime,this.sound.duration));return isNaN(i)?buzz.defaults.placeholder:i};this.setSpeed=function(i){if(!b){return this}this.sound.playbackRate=i};this.getSpeed=function(){if(!b){return null}return this.sound.playbackRate};this.getDuration=function(){if(!b){return null}var i=Math.round(this.sound.duration*100)/100;return isNaN(i)?buzz.defaults.placeholder:i};this.getPlayed=function(){if(!b){return null}return m(this.sound.played)};this.getBuffered=function(){if(!b){return null}return m(this.sound.buffered)};this.getSeekable=function(){if(!b){return null}return m(this.sound.seekable)};this.getErrorCode=function(){if(b&&this.sound.error){return this.sound.error.code}return 0};this.getErrorMessage=function(){if(!b){return null}switch(this.getErrorCode()){case 1:return"MEDIA_ERR_ABORTED";case 2:return"MEDIA_ERR_NETWORK";case 3:return"MEDIA_ERR_DECODE";case 4:return"MEDIA_ERR_SRC_NOT_SUPPORTED";default:return null}};this.getStateCode=function(){if(!b){return null}return this.sound.readyState};this.getStateMessage=function(){if(!b){return null}switch(this.getStateCode()){case 0:return"HAVE_NOTHING";case 1:return"HAVE_METADATA";case 2:return"HAVE_CURRENT_DATA";case 3:return"HAVE_FUTURE_DATA";case 4:return"HAVE_ENOUGH_DATA";default:return null}};this.getNetworkStateCode=function(){if(!b){return null}return this.sound.networkState};this.getNetworkStateMessage=function(){if(!b){return null}switch(this.getNetworkStateCode()){case 0:return"NETWORK_EMPTY";case 1:return"NETWORK_IDLE";case 2:return"NETWORK_LOADING";case 3:return"NETWORK_NO_SOURCE";default:return null}};this.set=function(i,j){if(!b){return this}this.sound[i]=j;return this};this.get=function(i){if(!b){return null}return i?this.sound[i]:this.sound};this.bind=function(k,r){if(!b){return this}k=k.split(" ");var q=this,s=function(t){r.call(q,t)};for(var j=0;j<k.length;j++){var p=k[j],i=p;p=i.split(".")[0];n.push({idx:i,func:s});this.sound.addEventListener(p,s,true)}return this};this.unbind=function(q){if(!b){return this}q=q.split(" ");for(var p=0;p<q.length;p++){var j=q[p],s=j.split(".")[0];for(var k=0;k<n.length;k++){var r=n[k].idx.split(".");if(n[k].idx==j||(r[1]&&r[1]==j.replace(".",""))){this.sound.removeEventListener(s,n[k].func,true);delete n[k]}}}return this};this.bindOnce=function(i,k){if(!b){return this}var j=this;c[h++]=false;this.bind(h+i,function(){if(!c[h]){c[h]=true;k.call(j)}j.unbind(h+i)})};this.trigger=function(s){if(!b){return this}s=s.split(" ");for(var r=0;r<s.length;r++){var j=s[r];for(var q=0;q<n.length;q++){var p=n[q].idx.split(".");if(n[q].idx==j||(p[0]&&p[0]==j.replace(".",""))){var k=document.createEvent("HTMLEvents");k.initEvent(p[0],false,true);this.sound.dispatchEvent(k)}}}return this};this.fadeTo=function(s,p,r){if(!b){return this}if(p instanceof Function){r=p;p=buzz.defaults.duration}else{p=p||buzz.defaults.duration}var q=this.volume,j=p/Math.abs(q-s),k=this;this.play();function i(){setTimeout(function(){if(q<s&&k.volume<s){k.setVolume(k.volume+=1);i()}else{if(q>s&&k.volume>s){k.setVolume(k.volume-=1);i()}else{if(r instanceof Function){r.apply(k)}}}},j)}this.whenReady(function(){i()});return this};this.fadeIn=function(i,j){if(!b){return this}return this.setVolume(0).fadeTo(100,i,j)};this.fadeOut=function(i,j){if(!b){return this}return this.fadeTo(0,i,j)};this.fadeWith=function(j,i){if(!b){return this}this.fadeOut(i,function(){this.stop()});j.play().fadeIn(i);return this};this.whenReady=function(j){if(!b){return null}var i=this;if(this.sound.readyState===0){this.bind("canplay.buzzwhenready",function(){j.call(i)})}else{j.call(i)}};function m(j){var q=[],p=j.length-1;for(var k=0;k<=p;k++){q.push({start:j.start(p),end:j.end(p)})}return q}function l(i){return i.split(".").pop()}function e(j,k){var i=document.createElement("source");i.src=k;if(buzz.types[l(k)]){i.type=buzz.types[l(k)]}j.appendChild(i)}if(b){for(var g in buzz.defaults){if(buzz.defaults.hasOwnProperty(g)){o[g]=o[g]||buzz.defaults[g]}}this.sound=document.createElement("audio");if(a instanceof Array){for(var f in a){if(a.hasOwnProperty(f)){e(this.sound,a[f])}}}else{if(o.formats.length){for(var d in o.formats){if(o.formats.hasOwnProperty(d)){e(this.sound,a+"."+o.formats[d])}}}else{e(this.sound,a)}}if(o.loop){this.loop()}if(o.autoplay){this.sound.autoplay="autoplay"}if(o.preload===true){this.sound.preload="auto"}else{if(o.preload===false){this.sound.preload="none"}else{this.sound.preload=o.preload}}this.setVolume(o.volume);buzz.sounds.push(this)}},group:function(a){a=c(a,arguments);this.getSounds=function(){return a};this.add=function(e){e=c(e,arguments);for(var d=0;d<e.length;d++){a.push(e[d])}};this.remove=function(f){f=c(f,arguments);for(var d=0;d<f.length;d++){for(var e=0;e<a.length;e++){if(a[e]==f[d]){delete a[e];break}}}};this.load=function(){b("load");return this};this.play=function(){b("play");return this};this.togglePlay=function(){b("togglePlay");return this};this.pause=function(d){b("pause",d);return this};this.stop=function(){b("stop");return this};this.mute=function(){b("mute");return this};this.unmute=function(){b("unmute");return this};this.toggleMute=function(){b("toggleMute");return this};this.setVolume=function(d){b("setVolume",d);return this};this.increaseVolume=function(d){b("increaseVolume",d);return this};this.decreaseVolume=function(d){b("decreaseVolume",d);return this};this.loop=function(){b("loop");return this};this.unloop=function(){b("unloop");return this};this.setTime=function(d){b("setTime",d);return this};this.setduration=function(d){b("setduration",d);return this};this.set=function(d,e){b("set",d,e);return this};this.bind=function(d,e){b("bind",d,e);return this};this.unbind=function(d){b("unbind",d);return this};this.bindOnce=function(d,e){b("bindOnce",d,e);return this};this.trigger=function(d){b("trigger",d);return this};this.fade=function(g,f,d,e){b("fade",g,f,d,e);return this};this.fadeIn=function(d,e){b("fadeIn",d,e);return this};this.fadeOut=function(d,e){b("fadeOut",d,e);return this};function b(){var d=c(null,arguments),f=d.shift();for(var e=0;e<a.length;e++){a[e][f].apply(a[e],d)}}function c(e,d){return(e instanceof Array)?e:Array.prototype.slice.call(d)}},all:function(){return new buzz.group(buzz.sounds)},isSupported:function(){return !!buzz.el.canPlayType},isOGGSupported:function(){return !!buzz.el.canPlayType&&buzz.el.canPlayType('audio/ogg; codecs="vorbis"')},isWAVSupported:function(){return !!buzz.el.canPlayType&&buzz.el.canPlayType('audio/wav; codecs="1"')},isMP3Supported:function(){return !!buzz.el.canPlayType&&buzz.el.canPlayType("audio/mpeg;")},isAACSupported:function(){return !!buzz.el.canPlayType&&(buzz.el.canPlayType("audio/x-m4a;")||buzz.el.canPlayType("audio/aac;"))},toTimer:function(e,b){var d,a,c;d=Math.floor(e/3600);d=isNaN(d)?"--":(d>=10)?d:"0"+d;a=b?Math.floor(e/60%60):Math.floor(e/60);a=isNaN(a)?"--":(a>=10)?a:"0"+a;c=Math.floor(e%60);c=isNaN(c)?"--":(c>=10)?c:"0"+c;return b?d+":"+a+":"+c:a+":"+c},fromTimer:function(b){var a=b.toString().split(":");if(a&&a.length==3){b=(parseInt(a[0],10)*3600)+(parseInt(a[1],10)*60)+parseInt(a[2],10)}if(a&&a.length==2){b=(parseInt(a[0],10)*60)+parseInt(a[1],10)}return b},toPercent:function(d,c,a){var b=Math.pow(10,a||0);return Math.round(((d*100)/c)*b)/b},fromPercent:function(d,c,a){var b=Math.pow(10,a||0);return Math.round(((c/100)*d)*b)/b}};const DEBUG=false;const OPTI=false;const T_TEX=1;const T_SOUND=2;const T_MUSIC=4;const SCREEN_WIDTH=640;const SCREEN_HEIGHT=500;const UNIT_WIDTH=25;const UNIT_HEIGHT=25;const FPS=60;const MATH_PI=Math.PI;const MATH_PI_HALF=MATH_PI/2;const MATH_TWO_PI=2*MATH_PI;const MEDIA_TEX_PATH="media/textures/";const MEDIA_SOUND_PATH="media/sounds/";const KEY_REPEAT=4;const KEY_LEFT=37;const KEY_LEFT2=65;const KEY_UP=38;const KEY_UP2=87;const KEY_RIGHT=39;const KEY_RIGHT2=68;const KEY_DOWN=40;const KEY_DOWN2=83;const KEY_SPACE=32;const KEY_C=86;const KEY_PAUSE=80;const KEY_RESTART=82;const BONUS_1_LINES=100;const BONUS_2_LINES=300;const BONUS_3_LINES=800;const BONUS_4_LINES=2000;const BONUS_5_LINES=10000;function Debug(a){if(DEBUG){console.log(a)}}function E_TimeNow(){return new Date().getTime()}window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){window.setTimeout(b,1000/60)}})();function sleep(c){var b=new Date();var a=null;do{a=new Date()}while(a-b<c)}function File(a,c,b){this.file_type=(a&T_TEX)|(a&T_SOUND)|(a&T_MUSIC);if(!this.file_type){Debug("File > Error, file_type undefined...")}this.file_name=c;this.callback_func=b;this.file=null}File.prototype={load:function(){Debug("ResourcesLoader > File '"+this.file_name+"' is loading...");var a=this;switch(this.file_type){case T_TEX:this.file=new Image();this.file.src=MEDIA_TEX_PATH+this.file_name;this.file.onload=function(){a.done(a)};break;case T_SOUND:this.file=new buzz.sound(MEDIA_SOUND_PATH+this.file_name,{formats:["wav"],loop:false,});this.file.load();this.file.decreaseVolume(50);this.file.bind("canplaythrough",function(){a.done(a)});break;case T_MUSIC:this.file=new buzz.sound(MEDIA_SOUND_PATH+this.file_name,{formats:["ogg"],loop:true,});this.file.load();this.file.load();this.file.decreaseVolume(20);this.file.bind("canplaythrough",function(){a.done(a)});break}},done:function(a){Debug("ResourcesLoader > File '"+a.file_name+"' loaded!");a.callback_func(a)},};function ResourcesLoader(a,b,c){this.resource_manager=a;this.file_queue=b;this.file_nb=this.file_queue.tex.length+this.file_queue.sound.length+this.file_queue.music.length;this.callback_func=c;Debug("ResourcesLoader > "+this.file_nb+" file on the load list.")}ResourcesLoader.prototype={start:function(){var a=this;for(file_id in this.file_queue.tex){var b=new File(T_TEX,this.file_queue.tex[file_id],function(c){a.onResourceLoaded(c)});b.load()}for(file_id in this.file_queue.sound){var b=new File(T_SOUND,this.file_queue.sound[file_id],function(c){a.onResourceLoaded(c)});b.load()}for(file_id in this.file_queue.music){var b=new File(T_MUSIC,this.file_queue.music[file_id],function(c){a.onResourceLoaded(c)});b.load()}},onResourceLoaded:function(a){this.resource_manager.addResource(a);if(--this.file_nb<=0){this.done()}},done:function(){this.resource_manager.ready=true;Debug("callback_func called at the right place.");this.callback_func()}};function ResourceManager(){this.tex_list={};this.sound_list={};this.music_list={};this.ready=false;this.loader=null}ResourceManager.prototype={loadFiles:function(b,c){var a=this;this.loader=new ResourcesLoader(this,b,function(){c()});this.loader.start()},addResource:function(a){switch(a.file_type){case T_TEX:this.tex_list[a.file_name]=a.file;break;case T_SOUND:this.sound_list[a.file_name]=a.file;break;case T_MUSIC:this.music_list[a.file_name]=a.file;break}},getTexture:function(a){if(a in this.tex_list){return this.tex_list[a]}else{return undefined}},};function Sprite(b,a,c){this.width=b;this.height=a;this.rotation_angle=0;this.scale_factor=1;this.tex=c}Sprite.prototype={rotate:function(a){this.rotation_angle+=a},setRotationAngle:function(a){this.rotation_angle=a},scale:function(a){this.scale_factor+=a},setScaleFactor:function(a){this.scale_factor=a},needSpaceTransform:function(){return(this.rotation_angle!=0||this.scale_factor!=1)},wrapAngle:function(){if(this.rotation_angle>=MATH_TWO_PI){this.rotation_angle-=MATH_TWO_PI}else{if(this.rotation_angle<0){this.rotation_angle+=MATH_TWO_PI}}},render:function(d,a,f){var c=a;var b=f;var e=this.needSpaceTransform();if(e){d.save();if(this.rotation_angle!=0){this.wrapAngle();d.translate(c+this.width/2,b+this.height/2);d.rotate(-this.rotation_angle);d.translate(-c-this.width/2,-b-this.height/2)}if(this.scale_factor!=1){d.translate(c+this.width/2,b+this.height/2);d.scale(this.scale_factor,this.scale_factor);d.translate(-c-this.width/2,-b-this.height/2)}}d.drawImage(this.tex,c,b);if(e){d.restore()}},};const BLOCK_NORMAL=0;const BLOCK_MUTATE_ADD=1;const BLOCK_MUTATE_REM=2;function Block(a,b){this.grid_x=a;this.grid_y=b;this.is_falling=true;this.block_type=BLOCK_NORMAL;this.is_bonus=false;this.sprite_square=new Sprite(25,25,game.resource_manager.tex_list["block_blue.png"])}Block.prototype={move:function(b,a){this.grid_x+=b;this.grid_y+=a},render:function(b,a){this.sprite_square.render(b,this.grid_x*UNIT_WIDTH+a.x,this.grid_y*UNIT_HEIGHT+a.y)},setBlockType:function(a){this.block_type=a;if(this.block_type>0){this.is_bonus=true}else{this.is_bonus=false}switch(this.block_type){case BLOCK_MUTATE_REM:this.sprite_square=new Sprite(25,25,game.resource_manager.tex_list["block_red.png"]);break;case BLOCK_MUTATE_ADD:this.sprite_square=new Sprite(25,25,game.resource_manager.tex_list["block_green.png"]);break;default:this.sprite_square=new Sprite(25,25,game.resource_manager.tex_list["block_blue.png"]);break}},};const T_W=5;const T_H=5;const TETRIS_I=[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],];const TETRIS_O=[[0,0,0,0,0],[0,1,1,0,0],[0,1,1,0,0],[0,0,0,0,0],[0,0,0,0,0],];const TETRIS_T=[[0,0,0,0,0],[0,1,1,1,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],];const TETRIS_J=[[0,0,0,0,0],[0,1,1,1,0],[0,0,0,1,0],[0,0,0,0,0],[0,0,0,0,0],];const TETRIS_L=[[0,0,0,0,0],[0,1,1,1,0],[0,1,0,0,0],[0,0,0,0,0],[0,0,0,0,0],];const TETRIS_S=[[0,0,0,0,0],[0,0,1,1,0],[0,1,1,0,0],[0,0,0,0,0],[0,0,0,0,0],];const TETRIS_Z=[[0,0,0,0,0],[0,1,1,0,0],[0,0,1,1,0],[0,0,0,0,0],[0,0,0,0,0],];const TETRIS_PATTERNS=[TETRIS_Z,TETRIS_S,TETRIS_L,TETRIS_J,TETRIS_T,TETRIS_O,TETRIS_I];function PiecePattern(a){this.pattern=a}PiecePattern.prototype={mutate_add:function(){var a=[];var e;for(var d=0;d<T_W;++d){for(var c=0;c<T_H;++c){if(this.pattern[d][c]==1){if((e=c-1)>=0){if(this.pattern[d][e]==0){a.push([d,e])}}if((e=c+1)<T_W){if(this.pattern[d][e]==0){a.push([d,e])}}if((e=d-1)>=0){if(this.pattern[e][c]==0){a.push([e,c])}}if((e=d+1)<T_H){if(this.pattern[e][c]==0){a.push([e,c])}}}}}if(a.length==0){return}var b=a[Math.floor((Math.random()*a.length))];this.pattern[b[0]][b[1]]=1},mutate_rem:function(){var a=[];var f;var e;for(var d=0;d<T_W;++d){for(var c=0;c<T_H;++c){if(this.pattern[d][c]==1){e=0;if((f=c-1)>=0){if(this.pattern[d][f]==1){++e}}if((f=c+1)<T_W){if(this.pattern[d][f]==1){++e}}if((f=d-1)>=0){if(this.pattern[f][c]==1){++e}}if((f=d+1)<T_H){if(this.pattern[f][c]==1){++e}}if(e>=1){a.push([d,c])}}}}if(a.length==0){return}var b=a[Math.floor((Math.random()*a.length))];this.pattern[b[0]][b[1]]=0},};function GeneratePieceViaTetrisPattern(){var a=[];for(pattern_id in TETRIS_PATTERNS){a.push(new PiecePattern(TETRIS_PATTERNS[pattern_id]))}return a}const PIECE_X_ADJUST=3;const PIECE_Y_ADJUST=-3;function Piece(c){this.grid_x=0;this.grid_y=0;this.blocks=[];this.previous_state=[];this.pattern=c.pattern;for(var b=0;b<T_H;++b){for(var a=0;a<T_W;++a){if(this.pattern[a][b]==1){this.blocks.push(new Block(a,b))}}}this.in_x=0;this.in_y=0;this.computeInertialCenter();this.is_at_origin=true}Piece.prototype={adjustStartPosition:function(){this.grid_x=PIECE_X_ADJUST;this.grid_y=PIECE_Y_ADJUST;for(elt in this.blocks){this.blocks[elt].grid_x+=PIECE_X_ADJUST;this.blocks[elt].grid_y+=PIECE_Y_ADJUST}this.computeInertialCenter()},computeInertialCenter:function(){this.in_x=0;this.in_y=0;for(block_id in this.blocks){this.in_x+=this.blocks[block_id].grid_x;this.in_y+=this.blocks[block_id].grid_y}this.in_x/=this.blocks.length;this.in_y/=this.blocks.length},getBlockExposedFromLeft:function(){var a={};var b;for(block_id in this.blocks){b=this.blocks[block_id].grid_y;if(!(b in a)){a[b]=this.blocks[block_id]}else{if(a[b].grid_x>this.blocks[block_id].grid_x){a[b]=this.blocks[block_id]}}}return a},getBlockExposedFromRight:function(){var a={};var b;for(block_id in this.blocks){b=this.blocks[block_id].grid_y;if(!(b in a)){a[b]=this.blocks[block_id]}else{if(a[b].grid_x<this.blocks[block_id].grid_x){a[b]=this.blocks[block_id]}}}return a},getBlockExposedFromBottom:function(){var b={};var a;for(block_id in this.blocks){a=this.blocks[block_id].grid_x;if(!(a in b)){b[a]=this.blocks[block_id]}else{if(b[a].grid_y<this.blocks[block_id].grid_y){b[a]=this.blocks[block_id]}}}return b},addSpecialBlock:function(){var a=Math.floor((Math.random()*this.blocks.length));this.blocks[a].setBlockType(Math.floor((Math.random()*3)))},rotate:function(){var c;this.previous_state=[];for(block_id in this.blocks){c=new Block(this.blocks[block_id].grid_x,this.blocks[block_id].grid_y);c.setBlockType(this.blocks[block_id].block_type);this.previous_state.push(c);var d=this.blocks[block_id].grid_x;var a=this.blocks[block_id].grid_y;d-=this.in_x;a-=this.in_y;var b=d;d=-a;a=b;d+=this.in_x;a+=this.in_y;this.blocks[block_id].grid_x=Math.round(d);this.blocks[block_id].grid_y=Math.round(a)}},undoRotate:function(){var a;this.blocks=[];for(block_id in this.previous_state){a=new Block(this.previous_state[block_id].grid_x,this.previous_state[block_id].grid_y);a.setBlockType(this.previous_state[block_id].block_type);this.blocks.push(a)}},move:function(b,a){for(block_id in this.blocks){this.blocks[block_id].move(b,a)}this.computeInertialCenter();this.is_at_origin=false},render:function(b,a){for(block_id in this.blocks){this.blocks[block_id].render(b,a)}},};function Background(b,a){this.width=b*UNIT_WIDTH;this.height=a*UNIT_HEIGHT;this.point={x:0,y:0,dx:5,dy:5}}Background.prototype={render:function(f,h){var d=255;grad=f.createRadialGradient(0,0,0,0,0,600);grad.addColorStop(0,"#000");grad.addColorStop(1,"rgb("+d+", "+d+", "+d+")");f.fillStyle=grad;f.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);this.point.x+=this.point.dx;this.point.y+=this.point.dy;if(this.point.x<0){this.point.dx*=-1;this.point.x=0}if(this.point.y<0){this.point.dy*=-1;this.point.y=0}if(this.point.x>SCREEN_WIDTH){this.point.dx*=-1;this.point.x=SCREEN_WIDTH}if(this.point.y>SCREEN_HEIGHT){this.point.dy*=-1;this.point.y=SCREEN_HEIGHT}var c=1000,j=800,i=this.point.x,g=this.point.y,b=SCREEN_WIDTH*i/c,a=SCREEN_HEIGHT*g/j;var k=~~(256*i/c);var e=~~(256*g/j);grad=f.createRadialGradient(b,a,0,b,a,600);grad.addColorStop(0,"#000");grad.addColorStop(1,["rgb(",k,", ",(255-k),", ",e,")"].join(""));f.fillStyle=grad;f.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);f.fillStyle="rgba(0, 0, 0, 0.6)";f.fillRect(h.x,h.y,this.width,this.height);f.strokeStyle="silver";f.strokeRect(h.x,h.y,this.width,this.height)},};function UI_NextPiece(a,b){this.pos_x=a;this.pos_y=b;this.piece_pattern_id=-1;this.piece=null;this.is_mutated=false}UI_NextPiece.prototype={setNextPiece:function(a,b){this.piece_pattern_id=a;this.piece=b;this.is_mutated=false},render:function(a){a.fillStyle="rgba(0, 0, 0, 0.6)";a.fillRect(this.pos_x,this.pos_y,UNIT_WIDTH*5+4,UNIT_HEIGHT*5+4);a.strokeStyle="silver";a.strokeRect(this.pos_x,this.pos_y,UNIT_WIDTH*5+4,UNIT_HEIGHT*5+4);this.piece.render(a,{x:this.pos_x+UNIT_WIDTH*(2-this.piece.in_x),y:this.pos_y+UNIT_HEIGHT*(2-this.piece.in_y)});if(this.is_mutated){a.fillStyle="#fff";a.textAlign="Center";a.font="bold 100px Arial";a.fillText("?",this.pos_x+UNIT_WIDTH*2,this.pos_y+UNIT_HEIGHT*2)}},};function UI_ScoreCounter(a,b){this.pos_x=a;this.pos_y=b;this.score=0;this.displayed_score=0}UI_ScoreCounter.prototype={addValue:function(a){this.score+=a},addValueRealtime:function(a){this.score+=a;this.displayed_score+=a},update:function(){if(this.displayed_score<this.score){var a=Math.floor((this.score-this.displayed_score)/10);if(a<1){a=1}this.displayed_score+=a}else{this.displayed_score=this.score}},render:function(a){a.fillStyle="#fff";a.textAlign="Left";a.font="bold 30px Verdana";a.fillText("Score",this.pos_x,this.pos_y);a.fillText(this.displayed_score,this.pos_x,this.pos_y+1.5*UNIT_HEIGHT)},};function UI_LineCounter(a,b){this.pos_x=a;this.pos_y=b;this.counter=0}UI_LineCounter.prototype={addValue:function(a){this.counter+=a},render:function(a){a.fillStyle="#fff";a.textAlign="Left";a.font="bold 30px Verdana";a.fillText("Lines",this.pos_x,this.pos_y);a.fillText(this.counter,this.pos_x,this.pos_y+1.5*UNIT_HEIGHT)},};function EvolutiveMusic(){this.level=1;this.tracks={1:game.resource_manager.music_list.music1,2:game.resource_manager.music_list.music2,3:game.resource_manager.music_list.music3,4:game.resource_manager.music_list.music4,};this.current_track=this.tracks[1];this.current_track_nb=1}EvolutiveMusic.prototype={setCorrectTrack:function(b){var a=b*100;var c=this.current_track_nb;if(a<25){c=4}else{if(a<50){c=3}else{if(a<75){c=2}else{c=1}}}if(this.current_track_nb!=c){this.current_track_nb=c;this.current_track.stop();this.current_track=this.tracks[this.current_track_nb];this.current_track.play()}},stop:function(){this.current_track.stop()},play:function(){this.current_track.play()},playGameOverMusic:function(){this.current_track.stop()},};const LEVEL_GRID_WIDTH=10;const LEVEL_GRID_HEIGHT=18;function Level(c){this.game=c;this.grid_width=LEVEL_GRID_WIDTH;this.grid_height=LEVEL_GRID_HEIGHT;this.grid_view={x:UNIT_WIDTH*4,y:UNIT_HEIGHT};this.update_counter=0;this.keyrepeat_counter=0;this.difficulty=0.5;this.score_before_level_up=10;this.max_height=LEVEL_GRID_HEIGHT;this.tetris_count=0;this.mystic_tetris_count=0;this.mutation_count=0;this.piece_pattern_list=GeneratePieceViaTetrisPattern();this.music=new EvolutiveMusic();this.music.play();this.blocks=[];var a=[];for(var b=0;b<this.grid_width;++b){this.blocks[b]=new Array(this.grid_height)}this.background=new Background(this.grid_width,this.grid_height);this.UI_next_piece=new UI_NextPiece(UNIT_WIDTH*17.25,UNIT_HEIGHT*6);this.generateNextPiece();this.UI_score_counter=new UI_ScoreCounter(UNIT_WIDTH*17.5,UNIT_HEIGHT*13);this.UI_line_counter=new UI_LineCounter(UNIT_WIDTH*17.5,UNIT_HEIGHT*16.5);this.falling_piece=this.generateRandomPiece();this.is_finished=false;this.disable_space=false;this.disable_pause=false}Level.prototype={update:function(a){if(a[KEY_PAUSE]){if(!this.disable_pause){this.is_paused=!this.is_paused;if(this.is_paused){this.music.stop()}else{this.music.play()}}this.disable_pause=true}else{this.disable_pause=false}if(this.is_paused){return}this.UI_score_counter.update();if(++this.keyrepeat_counter>=KEY_REPEAT){this.keyrepeat_counter=0;if(this.falling_piece){if(a[KEY_LEFT]){var c=this.falling_piece.getBlockExposedFromLeft();var b=0;var e=true;for(f in c){b=c[f].grid_x-1;if(b<0){e=false;break}if(this.blocks[b][f]!=null){e=false;break}}if(e){this.falling_piece.move(-1,0)}}else{if(a[KEY_RIGHT]){var c=this.falling_piece.getBlockExposedFromRight();var b=0;var e=true;for(f in c){b=c[f].grid_x+1;if(b>=this.grid_width){e=false;break}if(this.blocks[b][f]!=null){e=false;break}}if(e){this.falling_piece.move(1,0)}}}if(a[KEY_DOWN]){var c=this.falling_piece.getBlockExposedFromBottom();var f=0;var e=true;for(b in c){f=c[b].grid_y+1;if(f>=this.grid_height){e=false;break}if(this.blocks[b][f]!=null){e=false;break}}if(e){this.falling_piece.move(0,1);this.UI_score_counter.addValueRealtime(1)}}if(a[KEY_SPACE]){if(!this.disable_space){this.falling_piece.rotate();var e=true;var d=null;for(block_id in this.falling_piece.blocks){d=this.falling_piece.blocks[block_id];if(d.grid_x<0||d.grid_x>=this.grid_width){e=false;break}else{if(d.grid_y>=this.grid_height){e=false;break}else{if(this.blocks[d.grid_x][d.grid_y]!=null){e=false;break}}}}if(!e){this.falling_piece.undoRotate()}else{game.resource_manager.sound_list["switch"].play()}}this.disable_space=true}else{this.disable_space=false}}}if(++this.update_counter>=this.difficulty*FPS){this.update_counter=0;if(!this.falling_piece){this.falling_piece=this.UI_next_piece.piece;this.falling_piece.adjustStartPosition();this.generateNextPiece()}else{var c=this.falling_piece.getBlockExposedFromBottom();var f=0;var e=true;for(b in c){f=c[b].grid_y+1;if(f>=this.grid_height){e=false;break}if(this.blocks[b][f]!=null){e=false;break}}if(e){this.falling_piece.move(0,1)}else{game.resource_manager.sound_list.block.play();this.weldFallingPiece()}}this.checkLines()}},render:function(){this.background.render(this.game.renderer,this.grid_view);for(var b=0;b<this.grid_height;++b){for(var a=0;a<this.grid_width;++a){if(this.blocks[a][b]){this.blocks[a][b].render(this.game.renderer,this.grid_view)}}}if(this.falling_piece){this.falling_piece.render(this.game.renderer,this.grid_view)}this.UI_next_piece.render(this.game.renderer);this.UI_score_counter.render(this.game.renderer);this.UI_line_counter.render(this.game.renderer)},generateRandomPiece:function(){var a=new Piece(this.piece_pattern_list[Math.floor((Math.random()*this.piece_pattern_list.length))]);a.adjustStartPosition();a.addSpecialBlock();return a},generateNextPiece:function(){var b=Math.floor((Math.random()*this.piece_pattern_list.length));var a=new Piece(this.piece_pattern_list[b]);a.addSpecialBlock();this.UI_next_piece.setNextPiece(b,a)},updateNextPieceAfterBonus:function(){var b=this.UI_next_piece.piece_pattern_id;var a=new Piece(this.piece_pattern_list[b]);a.addSpecialBlock();this.UI_next_piece.setNextPiece(b,a);this.UI_next_piece.is_mutated=true},weldFallingPiece:function(){if(this.falling_piece.is_at_origin){this.is_finished=true;this.gameOver();return}var a;for(id in this.falling_piece.blocks){a=this.falling_piece.blocks[id];this.blocks[a.grid_x][a.grid_y]=a;if(a.grid_y<this.max_height){this.max_height=a.grid_y;this.music.setCorrectTrack(this.max_height/LEVEL_GRID_HEIGHT)}}this.falling_piece=null},scoredLines:function(a){this.UI_line_counter.addValue(a);if(a<4){game.resource_manager.sound_list.bonus.play()}else{game.resource_manager.sound_list.tetris.play()}var b=0;switch(a){case 2:b=BONUS_2_LINES;break;case 3:b=BONUS_3_LINES;break;case 4:b=BONUS_4_LINES;break;case 5:b=BONUS_5_LINES;break;default:b=BONUS_1_LINES;break}this.UI_score_counter.addValue(b);if(this.UI_line_counter.counter>=this.score_before_level_up){this.difficulty-=0.05;if(this.difficulty<0){this.difficulty=0}this.score_before_level_up+=10;game.resource_manager.sound_list.level.play()}},checkLines:function(){var e;var b={add:0,rem:0};var d=0;for(var c=0;c<this.grid_height;++c){e=true;for(var a=0;a<this.grid_width;++a){if(!this.blocks[a][c]){e=false;break}if(this.blocks[a][c].block_type==BLOCK_MUTATE_ADD){++b.add}else{if(this.blocks[a][c].block_type==BLOCK_MUTATE_REM){++b.rem}}}if(e){d++;this.applyGravity(c);if(b.add>0){this.piece_pattern_list[this.UI_next_piece.piece_pattern_id].mutate_add();++this.mutation_count;this.updateNextPieceAfterBonus()}if(b.rem>0){this.piece_pattern_list[this.UI_next_piece.piece_pattern_id].mutate_rem();++this.mutation_count;this.updateNextPieceAfterBonus()}}}if(d>0){this.scoredLines(d)}},applyGravity:function(c){var e;var d=LEVEL_GRID_HEIGHT;for(var b=c;b>0;--b){for(var a=0;a<this.grid_width;++a){e=this.blocks[a][b];if(e){e.move(0,1);if(e.grid_y<d){d=e.grid_y}}this.blocks[a][b]=this.blocks[a][b-1]}}this.max_height=d;this.music.setCorrectTrack(this.max_height/LEVEL_GRID_HEIGHT)},gameOver:function(){this.music.playGameOverMusic();this.game.renderer.fillStyle="gold";this.game.renderer.textAlign="center";this.game.renderer.font="bold 20px Arial";this.game.renderer.fillText("GAME OVER",this.game.surface.width/2,this.game.surface.height/2)}};function Game(){var a=this;this.surface=document.getElementById("game");this.surface.innerHTML="";this.surface.width=SCREEN_WIDTH;this.surface.height=SCREEN_HEIGHT;this.renderer=this.surface.getContext("2d");this.resource_manager=new ResourceManager;this.is_running=false;this.current_level=null;this.keyboard={status:{},onKeydown:function(b){b.preventDefault();this.status[b.keyCode]=true},onKeyup:function(b){delete this.status[b.keyCode]},};window.addEventListener("keydown",function(b){a.keyboard.onKeydown(b)},false);window.addEventListener("keyup",function(b){a.keyboard.onKeyup(b)},false);window.addEventListener("keydown",function(b){b.preventDefault()},false);window.onload=document.getElementById("game").focus();this.frame_count=0;this.last_computed_FPS_time=E_TimeNow()-1000;this.realtime_FPS=0}Game.prototype={load:function(a,b){if(!this.resource_manager.ready){this.resource_manager.loadFiles(a,b)}},init:function(){this.is_running=true;this.current_level=new Level(this)},update:function(){if(this.keyboard.status[KEY_RESTART]){this.current_level=new Level(this)}if(this.current_level.is_finished){return}this.current_level.update(this.keyboard.status)},render:function(){if(this.current_level.is_finished){return}this.renderer.clearRect(0,0,this.surface.width,this.surface.height);this.current_level.render()},debugLog:function(){this.frame_count++;var a=E_TimeNow();if(a-this.last_computed_FPS_time>=1000){this.last_computed_FPS_time=a;this.realtime_FPS=this.frame_count;this.frame_count=0}},};document.addEventListener("DOMContentLoaded",init,false);var game=null;function init(){Debug("Main > DOMContentLoaded.");var a={tex:["block_blue.png","block_green.png","block_red.png",],sound:["block","switch","bonus","tetris","level",],music:["music1","music2","music3","music4",],};game=new Game();game.load(a,onGameLoaded)}function onGameLoaded(){Debug("Main > All game resources loaded, starting game main loop.");game.init();runGame()}function runGame(){game.update();game.render();if(DEBUG){game.debugLog()}requestAnimFrame(runGame)};